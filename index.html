<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Visor de Imágenes WM (PostgreSQL)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{ --bg:#f5f5f5; --card:#fff; --ink:#222; --muted:#666; --accent:#2d6cdf;
      --chip:#eef4ff; --ok:#0a7; --warn:#d80; --bad:#c22; }
    *{box-sizing:border-box}
    body{font-family:Arial, sans-serif; margin:0; background:var(--bg); color:var(--ink);}
    header{text-align:center; padding:20px 10px; font-weight:700; font-size:1.6rem;}
    .controls{display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; padding:10px;}
    input[type="text"],button{padding:8px 10px; font-size:14px;}
    button{background:var(--accent); color:#fff; border:0; border-radius:8px; cursor:pointer;}
    #status{text-align:center; font-size:14px; color:#555; padding:5px 10px;}
    .gallery{display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:14px; padding:18px; max-width:1400px; margin:0 auto 30px;}
    .card{background:var(--card); border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,.06); overflow:hidden; border:1px solid #eee;}
    .thumb{width:100%; aspect-ratio:4/3; object-fit:cover; display:block; background:#000; cursor:pointer;}
    .meta{padding:10px 12px; font-size:12px; color:#444; display:grid; gap:8px}
    .kv{display:grid; grid-template-columns:140px 1fr; gap:6px 10px}
    .kv .k{font-weight:700;color:#1f2937}
    .kv .v{white-space:pre-wrap; word-wrap:anywhere}
    .chips{display:flex; gap:6px; flex-wrap:wrap; align-items:center;}
    .chip{background:var(--chip); padding:3px 8px; border-radius:999px; font-size:11px; border:1px solid #dfe8ff;}
    .chip.ok{border-color:#bfeee1; background:#f2fffb}
    .chip.warn{border-color:#ffe3bf; background:#fff8ee}
    .chip.bad{border-color:#ffd4d4; background:#fff3f3}
    .btn-link{display:inline-block; padding:6px 10px; font-size:12px; border-radius:8px; border:1px solid #cbd5e1; text-decoration:none;}
    .btn-link:hover{background:#f1f5f9}
    .url{color:var(--muted); font-size:11px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}

    /* rating */
    .rating{display:grid; gap:8px; padding:8px; border:1px dashed #2d6cdf33; border-radius:10px}
    .rating .q{font-weight:700;font-size:12px}
    .rating .opts{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .rating .btn{background:#eef4ff;color:#1f2a44;border:1px solid #cbd5e1;border-radius:999px;padding:6px 10px;cursor:pointer;font-size:12px}
    .rating .btn.on{outline:2px solid #2d6cdf}
    .rating .saved{font-size:11px;color:#0a7}

    /* modal */
    .modal{display:none; position:fixed; inset:0; background:rgba(0,0,0,.92); z-index:1000; align-items:center; justify-content:center;}
    .modal-inner{display:flex; gap:18px; max-width:94vw; max-height:86vh; align-items:center;}
    .modal img{max-width:62vw; max-height:80vh; border-radius:10px; background:#000;}
    .side{background:#111; color:#e9e9e9; padding:12px 14px; border-radius:10px; max-width:28vw; overflow:auto; max-height:80vh; font-size:13px;}
    .side h4{margin:0 0 8px 0; font-size:14px; color:#fff}
    .side .url{color:#bbb;}
    .close{position:absolute; top:16px; right:22px; font-size:2rem; color:#fff; cursor:pointer; user-select:none;}
    .nav{position:absolute; top:50%; transform:translateY(-50%); font-size:2.2rem; color:#fff; cursor:pointer; user-select:none; padding:8px 12px;}
    .prev{left:18px;} .next{right:18px;}

    /* login simplificado */
    #login{display:flex;gap:8px;justify-content:center;align-items:center;flex-wrap:wrap;margin-top:8px}
  </style>
</head>
<body>
  <header>Visor de Imágenes WM (PostgreSQL)</header>

  <!-- “Login” simple: solo define quién califica -->
  <div id="login">
    <input id="user" placeholder="Tu correo o alias" />
    <button id="btnSetUser">Usar usuario</button>
    <span id="who"></span>
  </div>

  <div class="controls">
    <input type="text" id="nicInput" placeholder="Ingrese NIC (Suscriptor)" />
    <button id="btnBuscar">Buscar</button>
  </div>
  <div id="status">Conectado al backend. Ingresa un NIC y pulsa Buscar.</div>

  <div class="gallery" id="gallery"></div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <span class="close" id="btnCerrar" title="Cerrar">&times;</span>
    <span class="nav prev" id="btnPrev" title="Anterior">&#10094;</span>
    <div class="modal-inner">
      <img id="modalImg" src="">
      <div class="side" id="sideMeta">
        <h4>Detalle</h4>
        <div class="kv" id="sideKv"></div>
        <div class="rating" id="modalRating" style="margin-top:8px;">
          <div class="q">¿La foto te sirvió para tomar la decisión?</div>
          <div class="opts">
            <button class="btn" data-v="Sí">Sí</button>
            <button class="btn" data-v="No">No</button>
            <span class="saved" id="modalSaved" style="display:none">✔ guardado</span>
          </div>
        </div>
        <div class="actions" id="sideActions"></div>
        <div class="url" id="sideUrl"></div>
      </div>
    </div>
    <span class="nav next" id="btnNext" title="Siguiente">&#10095;</span>
  </div>

<script>
/* ================== Config API + sesión usuario ================== */
const API_BASE = "http://localhost:3000"; // ajusta si tu backend usa otra URL/puerto

let CURRENT_USER = localStorage.getItem('wm_user') || 'usuario-local';
let CURRENT_UID  = CURRENT_USER;
function setUser(u){
  CURRENT_USER = (u||'usuario-local').trim();
  CURRENT_UID  = CURRENT_USER; // usamos el alias como user_id
  localStorage.setItem('wm_user', CURRENT_USER);
  document.getElementById('who').textContent = `Usando: ${CURRENT_USER}`;
}
document.getElementById('btnSetUser').onclick = ()=>{
  const u = document.getElementById('user').value || CURRENT_USER;
  setUser(u);
};
setUser(CURRENT_USER);

/* ================== Helpers ================== */
const $=id=>document.getElementById(id);
const statusMsg=t=>$('status').textContent=t;
const pad2=n=>String(n).padStart(2,'0');
function escapeHtml(v){return String(v ?? '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));}
function formatFechaSmart(val){
  if(val==null||val==='') return '';
  // si viene en ms epoch
  if(/^\d{12,}$/.test(String(val))) {
    const d=new Date(Number(val));
    if(!isNaN(d)) return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
  }
  // si viene como texto tipo DD/MM/YYYY HH:MM:SS AM/PM o similar: mostramos tal cual
  return String(val);
}

/* ================== API calls ================== */
async function fetchPhotosByNic(nic){
  const r = await fetch(`${API_BASE}/photos?nic=${encodeURIComponent(nic)}`);
  if(!r.ok) throw new Error('Error HTTP '+r.status);
  return await r.json(); // array de filas
}
async function getMyRating(nic){
  const r = await fetch(`${API_BASE}/ratings/${encodeURIComponent(nic)}/${encodeURIComponent(CURRENT_UID)}`);
  if(r.status===204) return null;
  if(!r.ok) throw new Error('Error rating HTTP '+r.status);
  const data = await r.json();
  return data?.value || null;
}
async function saveRating(nic, value){
  const r = await fetch(`${API_BASE}/ratings/${encodeURIComponent(nic)}/${encodeURIComponent(CURRENT_UID)}`,{
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ value, user: CURRENT_USER })
  });
  if(!r.ok) throw new Error('No se pudo guardar rating');
  return true;
}

/* ================== UI principal ================== */
let MATCHES=[], modalIdx=0, CURRENT_NIC='';

$('btnBuscar').onclick = async ()=>{
  const q = $('nicInput').value.trim();
  if(!q){ statusMsg('Escribe un NIC para buscar.'); return; }
  try{
    statusMsg(`Buscando NIC ${q}...`);
    const rows = await fetchPhotosByNic(q);
    MATCHES = rows || [];
    CURRENT_NIC = q;
    if(!MATCHES.length){
      statusMsg(`No hay resultados para NIC: ${q}`);
      $('gallery').innerHTML = '<div class="empty" style="padding:12px;text-align:center;color:#666;">Sin resultados.</div>';
    }else{
      statusMsg(`Encontradas ${MATCHES.length} filas para NIC ${q}.`);
      await renderGallery(MATCHES);
    }
  }catch(e){
    console.error(e);
    statusMsg('Error consultando la API. Revisa que el backend esté activo y CORS habilitado.');
  }
};

function infoPairs(row){
  // Mapea TODOS tus campos conocidos. Añade o quita según tu tabla.
  return [
    ["NIC", row.nic||""],
    ["Dirección", row.direccion||""],
    ["Fecha de Gestión", formatFechaSmart(row.fecha_gestion)],
    ["# Medidor", row.medidor||""],
    ["Lectura", row.lectura||""],
    ["Lectura Anterior", row.lectura_anterior||""],
    ["Tipo Magnitud", row.tipo_magnitud||""],
    ["Anomalía", row.anomalia||""],
    ["Ruta", row.ruta||""],
    ["Orden", row.orden||""],
    ["Secuencia", row.secuencia||""],
    ["Suscriptor", row.suscriptor||""],
    ["Estado", row.estado||""],
    ["Rescatable", row.rescatable||""],
    ["Tipo Medida", row.tipo_medida||""],
    ["Latitud", row.latitud||""],
    ["Longitud", row.longitud||""],
    ["Ciclo", row.ciclo||""],
    ["Periodo", row.periodo||""],
    ["Nombre Suscriptor", row.nombre_suscriptor||""],
    ["Fecha Cargue", row.fecha_cargue||""],
    ["Asignado por", row.asignado_por||""],
    ["Asignado a", row.asignado_a||""],
    ["Gestionada por", row.gestionada_por||""],
    ["Fecha Asignación", row.fecha_asignacion||""],
    ["Fecha Vencimiento", row.fecha_vencimiento||""],
    ["Contratista", row.contratista||""],
    ["Barrio", row.barrio||""],
    ["Municipio", row.municipio||""],
    ["Cod. Tipo Magnitud", row.cod_tipo_magnitud||""],
    ["Cod. Crítica", row.cod_critica||""],
    ["Consumo Promedio", row.consumo_promedio||""],
    ["Observación Padre", row.observacion_padre||""],
    ["Observación", row.observacion||""],
    ["Observación extra", row.observacion_extra||""],
    ["Solución Crítica", row.solucion_critica||""],
    ["Resultado Crítica", row.resultado_critica||""],
    ["Nota último intento", row.nota_ultimo_intento||""]
  ];
}
function buildMapButton(row){
  const la = parseFloat(String(row.latitud||'').replace(',','.'));
  const lo = parseFloat(String(row.longitud||'').replace(',','.'));
  if(!isFinite(la)||!isFinite(lo)) return '';
  return `<a class="btn-link" href="https://www.google.com/maps?q=${la},${lo}" target="_blank" rel="noopener">Ver en Google Maps</a>`;
}

async function renderGallery(rows){
  // precarga rating por NIC (mismo valor para todas las filas del mismo NIC)
  const rating = rows.length ? await getMyRating(rows[0].nic) : null;

  const g = $('gallery');
  g.innerHTML = rows.map((row, idx) => {
    const kv = infoPairs(row).map(([k,v])=> `<span class="k">${escapeHtml(k)}:</span><span class="v">${escapeHtml(v)}</span>`).join('');
    const url = row.evidencia || row.url || '';
    const anom = (row.anomalia||'').toLowerCase();
    let chipCls='chip'; if(/ok|normal|ninguna/.test(anom)) chipCls+=' ok'; else if(/advert|leve|warn/.test(anom)) chipCls+=' warn'; else if(anom) chipCls+=' bad';

    return `
      <div class="card">
        <img class="thumb" data-idx="${idx}" src="${escapeHtml(url)}" alt="img"/>
        <div class="meta">
          <div class="kv">${kv}</div>
          <div class="chips">${anom?`<span class="${chipCls}">Anomalía: ${escapeHtml(row.anomalia)}</span>`:''} ${buildMapButton(row)}</div>
          <div class="rating" data-nic="${escapeHtml(row.nic||'')}">
            <div class="q">¿La foto te sirvió para tomar la decisión?</div>
            <div class="opts">
              <button class="btn rate ${rating==='Sí'?'on':''}" data-v="Sí">Sí</button>
              <button class="btn rate ${rating==='No'?'on':''}" data-v="No">No</button>
              <span class="saved" style="display:${rating?'inline':'none'}">✔ guardado</span>
            </div>
          </div>
          <div class="url" title="${escapeHtml(url)}">${escapeHtml(url)}</div>
        </div>
      </div>`;
  }).join('');

  // handlers
  g.querySelectorAll('.thumb').forEach(img=>{
    img.addEventListener('click', ev => openModal(Number(ev.currentTarget.dataset.idx)));
  });
  g.querySelectorAll('.rating .rate').forEach(btn=>{
    btn.addEventListener('click', async e=>{
      const box = e.currentTarget.closest('.rating');
      const nic = box.dataset.nic;
      const val = e.currentTarget.dataset.v;
      try{
        await saveRating(nic, val);
        box.querySelectorAll('.rate').forEach(x=>x.classList.remove('on'));
        e.currentTarget.classList.add('on');
        box.querySelector('.saved').style.display='inline';
      }catch(err){ alert('No se pudo guardar la calificación'); }
    });
  });
}

/* ================== Modal ================== */
function openModal(i){
  modalIdx=i;
  const row = MATCHES[i]; if(!row) return;
  const url = row.evidencia || row.url || '';
  $('modalImg').src = url;
  $('sideKv').innerHTML = infoPairs(row).map(([k,v]) => `<div class="k">${escapeHtml(k)}:</div><div class="v">${escapeHtml(v)}</div>`).join('');
  $('sideActions').innerHTML = buildMapButton(row);
  $('sideUrl').textContent = url;
  $('sideUrl').title = url;
  applyModalRating(row.nic);
  $('modal').style.display = 'flex';
}
$('btnCerrar').onclick = () => $('modal').style.display = 'none';
$('btnPrev').onclick = () => { if (modalIdx>0) openModal(modalIdx-1); };
$('btnNext').onclick = () => { if (modalIdx<MATCHES.length-1) openModal(modalIdx+1); };
window.addEventListener('keydown', e => { if (e.key==='Escape') $('modal').style.display='none'; });

document.querySelectorAll('#modalRating .btn').forEach(b=>{
  b.addEventListener('click', async e=>{
    const row = MATCHES[modalIdx]; if(!row) return;
    const val = e.currentTarget.dataset.v;
    await saveRating(row.nic, val);
    await applyModalRating(row.nic);
    renderGallery(MATCHES);
  });
});
async function applyModalRating(nic){
  const v = await getMyRating(nic);
  document.querySelectorAll('#modalRating .btn').forEach(x=>x.classList.remove('on'));
  if(v) document.querySelector(`#modalRating .btn[data-v="${v}"]`)?.classList.add('on');
  $('modalSaved').style.display = v ? 'inline' : 'none';
}
</script>
</body>
</html>
