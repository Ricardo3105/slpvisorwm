<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Demo Firebase + Firestore</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
   body{font-family:system-ui,-apple-system,Arial,sans-serif; margin:24px; max-width:800px}
   h1{margin:0 0 8px}
   .muted{color:#666; margin:0 0 16px}
   form{display:flex; gap:8px; margin:12px 0}
   input,button{padding:10px 12px}
   ul{list-style:none; padding:0}
   li{display:flex; justify-content:space-between; align-items:center; padding:8px 10px; border:1px solid #eee; border-radius:8px; margin:6px 0}
   code{background:#f5f5f5; padding:2px 6px; border-radius:4px}
</style>
</head>
<body>
<h1>Demo Firebase + Firestore</h1>
<p class="muted">Autenticaci√≥n an√≥nima + lista en tiempo real (colecci√≥n <code>public</code> y privada por usuario)</p>
<section id="auth">
<strong>Estado:</strong> <span id="status">Conectando‚Ä¶</span>
</section>
<h2>Colecci√≥n p√∫blica</h2>
<form id="form-public">
<input id="input-public" placeholder="Escribe algo p√∫blico‚Ä¶" required />
<button type="submit">Agregar</button>
</form>
<ul id="list-public"></ul>
<h2>Tu colecci√≥n privada</h2>
<form id="form-private">
<input id="input-private" placeholder="Escribe algo privado‚Ä¶" required />
<button type="submit">Agregar</button>
</form>
<ul id="list-private"></ul>
<!-- Firebase SDKs (modular v10+) -->
<script type="module">
   // 1) Importar SDKs
   import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
   import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
   import {
     getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp,
     doc, deleteDoc
   } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
   // 2) TU CONFIG (reemplaza con la de tu proyecto)
   const firebaseConfig = {
     apiKey: "TU_API_KEY",
     authDomain: "TU_AUTH_DOMAIN",
     projectId: "TU_PROJECT_ID",
     storageBucket: "TU_STORAGE_BUCKET",
     messagingSenderId: "TU_SENDER_ID",
     appId: "TU_APP_ID"
   };
   // 3) Init
   const app = initializeApp(firebaseConfig);
   const auth = getAuth(app);
   const db   = getFirestore(app);
   const $status = document.getElementById('status');
   // 4) Login an√≥nimo
   signInAnonymously(auth).catch(err => {
     console.error("Error signInAnonymously:", err);
     $status.textContent = "Error de autenticaci√≥n";
   });
   onAuthStateChanged(auth, user => {
     if (user) {
       $status.textContent = `Autenticado (an√≥nimo). UID: ${user.uid}`;
       initRealtime(user.uid);
     } else {
       $status.textContent = "No autenticado";
     }
   });
   // 5) Listeners + CRUD
   function initRealtime(uid){
     // ----- Colecci√≥n P√öBLICA -----
     const publicRef = collection(db, "public");
     const qPublic   = query(publicRef, orderBy("createdAt","desc"));
     onSnapshot(qPublic, snap => {
       const $list = document.getElementById('list-public');
       $list.innerHTML = "";
       snap.forEach(d => {
         const li = renderItem(d.id, d.data(), () => deleteDoc(doc(db, "public", d.id)));
         $list.appendChild(li);
       });
     });
     document.getElementById('form-public').addEventListener('submit', async (e)=>{
       e.preventDefault();
       const value = document.getElementById('input-public').value.trim();
       if(!value) return;
       await addDoc(publicRef, {
         text: value,
         createdAt: serverTimestamp(),
         by: auth.currentUser?.uid || null
       });
       e.target.reset();
     });
     // ----- Colecci√≥n PRIVADA por usuario -----
     // Ruta: /users/{uid}/items
     const privateRefPath = `users/${uid}/items`;
     const privateRef     = collection(db, privateRefPath);
     const qPrivate       = query(privateRef, orderBy("createdAt","desc"));
     onSnapshot(qPrivate, snap => {
       const $list = document.getElementById('list-private');
       $list.innerHTML = "";
       snap.forEach(d => {
         const li = renderItem(d.id, d.data(), () => deleteDoc(doc(db, privateRefPath, d.id)));
         $list.appendChild(li);
       });
     });
     document.getElementById('form-private').addEventListener('submit', async (e)=>{
       e.preventDefault();
       const value = document.getElementById('input-private').value.trim();
       if(!value) return;
       await addDoc(privateRef, {
         text: value,
         createdAt: serverTimestamp()
       });
       e.target.reset();
     });
   }
   // Utilidad para pintar items con bot√≥n borrar
   function renderItem(id, data, onDelete){
     const li = document.createElement('li');
     li.innerHTML = `
<span>${escapeHtml(data.text || "(sin texto)")}</span>
<button aria-label="Eliminar">üóëÔ∏è</button>
     `;
     li.querySelector("button").onclick = onDelete;
     return li;
   }
   // Peque√±a utilidad para evitar inyecci√≥n de HTML
   function escapeHtml(s){
     return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
   }
</script>
</body>
</html>
